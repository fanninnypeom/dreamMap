<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>D3 World Map</title>
    <link href="http://libs.baidu.com/bootstrap/3.0.3/css/bootstrap.min.css" rel="stylesheet">
<link href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css" rel="stylesheet">
    <style>
      path {
        stroke: black;
        stroke-width: 0.5px;
        fill: black;
        opacity: 0.5;

      }
      .l{
        stroke: #D1EEEE;
        stroke-width:0.2px; 
      }
      .search-size{
        width:500px;
        overflow-x: stroke-width:1px;      }     
         
      }
      circle{
        fill:red;
        stroke: blue;
        opacity: 0.5;
        }
      .special_path{
        opacity: 0;
      }
    </style>
    <script src="http://d3js.org/d3.v3.min.js"></script>
  </head>

 

  <body>

<label class="checkbox-inline">
  <input id="0" type="checkbox" checked data-toggle="toggle"> 其他
</label>
<label class="checkbox-inline">
  <input id="1" type="checkbox" checked data-toggle="toggle"> 高速
</label>
<label class="checkbox-inline">
  <input id="2" type="checkbox" checked data-toggle="toggle"> 快速
</label>
<label class="checkbox-inline">
  <input id="3" type="checkbox" checked data-toggle="toggle"> 一般   
</label>


<div class="input-group search-size">
    <input id="road-search" type="text" class="form-control input-lg"><span class="input-group-addon btn btn-primary" onclick="searchRoad()">搜索</span>
</div>

<script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
<script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>
<script src="http://libs.baidu.com/bootstrap/3.0.3/js/bootstrap.min.js"></script>
    <script charset="utf-8" type="text/javascript">


      var width = 1200;
      var height = 1000;

      var use1 = [116.3980871279,39.9048200566];
      var goole = [116.4071591969 ,39.9046716842];

      var projection = d3.geo.mercator()
						.center(goole)
						.scale(112250)
    					.translate([width/2-18.8, height/2+32]);
      
      var svg = d3.select("body").append("svg")
          .attr("width", width)
          .attr("height", height);
      var path = d3.geo.path()
          .projection(projection);


      var background1 = svg.append("image")
                           .attr("class","back")
                           .attr("x",0)
                           .attr("y",0)
                           .attr("width",1100)
                           .attr("height",1000)
                          //.attr("style","fill:steelblue")
                          .attr("opacity","0.4")
                          .attr("xlink:href","images/bc1ex.jpg");   


      var g = svg.append("g");
      var color = d3.scale.category20();

      var v1 = 5,v2 = 10,v3 = 15,v4 = 20,v5 = 25, v6 = 30, v7 = 35,v8 = 40,v9 = 45;
      
      function color_choose(speed)
      {
          var color= "yellow";
                if(speed < v1)
                {
                    color= "#ff0000";
                }
                else if(speed < v2)
                {
                  color= "#ff3300";
                }
                else if(speed < v3)
                {
                  color= "#ff6600";
                }
                else if (speed <v4)
                  color= "#ff9900";
                else if (speed <v5)
                  color= "#ffcc00";
                else if (speed <v6)
                  color= "#ffff00";
                else if (speed <v7)
                  color= "#ccff00";
                else if (speed <v8)
                  color= "#9eef25";//"#99ff00 ";
                else if (speed <v9)
                  color= "#49db1a";//"#66ff00";
                else 
                  color= "#008B00";//"#54e425";//"#33ff00";
            return color;

      }
     

      var text_tile = svg.append("text")
                       .attr("x",15)
                       .attr("y",20)
                       .attr("dx","0.5em")
                       .attr("dy","1.5em")
                       .text(function(d){
                          return "Speed (km/h)"
                       });


      for(var i = 0;i<10;i++)
      {
        var colorect1 = svg.append("rect")
                           .attr("x",50)
                           .attr("y",70+i*20)
                           .attr("width",30)
                           .attr("height",20)
                           .style("fill",color_choose(5*i));

        var texts = svg.append("text")
                       .attr("x",15)
                       .attr("y",50+i*20)
                       .attr("dx","0.5em")
                       .attr("dy","1.5em")
                       .text(function(d){
                          return 5*i;
                       });

      }
      


      
        //show the point of beijing

        var peking = [116.3975273161,39.9086611069];
                  
        //var palace = [];
        var proPeking = projection(peking);

        

        d3.text("data/RTICLINK_BeiJing.json","application/json;charset=utf-8",function(text){

          //show the point of BeiJing
          svg.append("circle")
             .attr("class","point_of_peking")
             .attr("cx",proPeking[0])
             .attr("cy",proPeking[1])
             .attr("r",1)
             .style("fill","red");




          var topology=JSON.parse(text);
//      d3.json("data/RTICLINK_BeiJing.json", function(error, topology) {
          g.selectAll("path")
          .data(topology.features ) 
                    .enter()            
            .append("path")
          .attr("class", function(d,i){
               
                  return "l";  
            })
        .style("fill","white")
        .style("stroke-width","1.5px")

            .attr("d", path)
            .attr("id",function(d,i){
                return d.properties.MapID+String(parseInt(d.properties.Kind)-1)+d.properties.ID;
            })
            .attr("Kind",function(d,i){
              return d.properties.Kind;
            })
            .attr("Length",function(d,i){
                return d.properties.Length;
            }
            )
            .attr("name",function(d,i){
        return d.properties.Name;
            })
            .attr("show","1")
   //         .attr("data-toggle","popover")
   //         .attr("data-trigger","focus")
   //         .attr("title","详细信息")
            .attr("data-content",function(d,i){
              var idshow = d.properties.MapID+String(parseInt(d.properties.Kind)-1)+d.properties.ID;
              return "名字:"+d.properties.Name+" 长度:"+d.properties.Length+"km"+" 编号:"+idshow;
            })
//            .popover()
            .each(
              function(d,i){
//                  var txt="Name: "+d.properties.Name+"  Length: "+d.properties.Length+"km";
                $(this).popover({
                  title:"More information",
                  trigger:"hover",
//                  content:txt+" Speed: "+this.getAttribute("speed")+"km/h",
                  placement:"buttom",
                  container: "body"
                })
              }
              );
            ;
         });
 


      var a=d3.rgb(255,0,0);
      var b=d3.rgb(0,255,0);
      var compute=d3.interpolate(a,b);
      //new 
      var linear = d3.scale.linear()
                     .domain([0,50])
                     .range([0,1]);

      var ob=0;
        bigChange(ob);
      


function bigChange(o){

      file="data/"+o+"_extract.json";
      d3.json(file,function(err,ddd){
     
  var times=-1;

  var startTime=new Date().getTime();
  var timestart = null;
  var timer=window.setInterval(function() 
{ 
  times=times+1;
  change(times); 
  }, 30); 

//var a = 0,b =0,c = 0,d = 0,e= 0,f =0,g = 0,h=0,m=0,i=0;


/*
function change(t){
      var t1=t;
        for(var i=t1*8227;i<(t1+1)*8227;i=i+1){
          
          if(i>ddd.road.length-1){
            clearInterval(timer); 
            console.log("time   "+ob);
            if(ob>22)
            return;
            else{
              ob=ob+1;
              bigChange(ob);
              
            }
            return;
          }
          var id=ddd.road[i].ID;
          var t=document.getElementById(id);
          if(t!=null){
          var l=t.getAttribute("Length");
          var speed=l/(ddd.road[i].UsedTime/3600.0);
          var color = color_choose(speed);
          
          
          show=t.getAttribute("show");
     //     console.log("display"+display);
          d3.select(t).style("stroke",color);
          d3.select(t).style("fill","white");

          var txt=t.getAttribute("data-content");
          var txtArr=txt.split(" ");//将名字，长度，速度分割，保留名字和长度，更新速度
          //console.log("txt"+txtArr.length);
          
          d3.select(t).attr("data-content",txtArr[0]+" "+txtArr[1]+" "+txtArr[2]+" 速度:"+speed+"km/h"+" ");
          
      }
          }
        }
      });



      */
      //var i = 0;

function change(t){
      var t1=t;
      var node = null;
      
      //var timer = 0;
      //console.log("------"+t1);
        for(var i=t1*8227;i<(t1+1)*8227;i=i+1){
          if(i == 0||i%8227 ==0){
            
            if(i ==0)
              timestart = ddd.road[i].time;
            //console.log(ddd.road[i].time);
            //console.log("-------TIME--STart------"+"\n");
          }
          
          if(i>ddd.road.length-1){
            clearInterval(timer); 
            console.log("time   "+ob);
            if(ob>22) //0
            {

              return;

            }
            else{
              ob=ob+1;
              bigChange(ob);
              
            }
            return;
          }
          var id=ddd.road[i].ID;
          if(!(id == 6056033374))

          /*
          if(!(id==5956721192||id == 5956721193 ||id == 5956721196||id == 5956721197||id == 5956721199|| id == 5956721195 || id == 5956621281|| id == 5956621283|| id == 5956621284|| id == 5956721286
            || id == 5956721206
            || id == 5956721186
            || id == 5956721188
            || id == 5956721416
            || id == 5956721413
            || id == 5956731414
            || id == 5956731357
            || id == 595673138
            || id == 595673124
            || id == 595673125
            || id == 595673117
            || id == 595673116
            || id == 595673129
            || id == 5956731460
            || id == 595673132
            || id == 595673111
            || id == 595673134
            || id == 595673170
            || id == 595673135
            || id == 59567316
            || id == 595673137
            || id == 59567313
            || id == 595673139
            || id == 595673140
            || id == 5956631448
            || id == 595673
            || id == 595673
            || id == 595673

          ))*/
          
          
        
            //(!(id.indexOf("59567211") >= 0 ||id.indexOf("5956731") >= 0||id.indexOf("59566221") >= 0 ||id.indexOf("59566311") >= 0))
         
              continue;
          else{
            //console.log("---fin----");
          }
          
          var t=document.getElementById(id);

          if(t!=null){
            var Kind_id = t.getAttribute("Kind");
            /*
            if(Kind_id !=2){
              continue;
            }
            */
            
            //console.log("have find it" + i+"----");
            var path_old = t.getAttribute("d");
            var l=t.getAttribute("Length");
            var timermin = ddd.road[i].UsedTime;
            if(timermin>500)
            { //console.log("============"+timermin +"order:"+timer);
              //timer++;
            }

            var speed=l/(ddd.road[i].UsedTime/3600.0);
            var color = color_choose(speed);
            
            
            
            
            var sp = path_old.replace(/[A-Z,]/g," ");
            var array = sp.split(" ");
            
              //console.log(array.length());
              //console.log(array[0]);
            //console.log(array[1]);
            //console.log(array[2]);
            index_end = (ddd.road[i].time - timestart)/60;
            //console.log("----END----"+index_end);
            //id1 = id+"s";
            id1 = id+"s"+index_end;

            //console.log("strat"+id1);
            id2 = id+"p";

            var circle1=document.getElementById(id1);
            var path=d3.select(document.getElementById(id));
            //console.log(id);
            //var circle1 = document.getElementById(id1)
            if(circle1==null){
                //var div = svg.append("div");
            circle1 = svg.append("circle")
                                .attr("id",id1)
                                .attr("r",2)
                                .attr("fill",color)
                                //.attr("style:","fill:"+color)
                                .attr("transform","translate("+array[1]+","+array[2]+")"); 
            /*                 
            console.log("First_initial");
            console.log(circle1);
            console.log("\n");
            */

           /* path = svg.append("path")
                        .data(path_old)
                        .attr("id",id2)
                        .attr("d",path)
                        //.attr("fill","red")
                        .attr("stroke","black")
                        .attr("class","special_path");
            */
            //path = d3.select(document.getElementById(id));
            //console.log(circle1);
            //console.log(path);
            ///d3.select()
                        /*
            console.log("\n");
            //console.log(path1);
            console.log("\n");
            console.log("\n");
            */


            
          }
          else{
              

            //console.log(circle1);

            //console.log(path1);
          //}

           // circle1.attr("fill",color);
          
           //path = d3.select(document.getElementById(id));
      //     console.log(path);
           //console.log("-----"+document.getElementById(id2));


            //console.log("---we have find---   "+id1);
            circle1=d3.select(document.getElementById(id1))
                     .attr("fill",color);
            //console.log(circle1);

            }
            
                         


            /*
            }
            else{
              ;
            }
            console.log(circle);
            */
            
            //show=circle.getAttribute("show");
     //     console.log("display"+display);
          //d3.select(show).style("stroke",color);
        //d3.select(circle).attr("fill",color);
          //console.log("ppppp\n")

           




          transition();

          function transition() {
            //var l = route.node().getTotalLength();
            //console.log(circle);
            //console.log("-----------"+timermin+"-------");
            circle1.transition()
                  .duration(timermin)//
                  .attrTween("transform",translateAlong(path.node()))
                  .each("end",function(d,i){
                        //console.log("end"+i);
                        this.remove();
                  });

            
          }
          
          function translateAlong(path){
            var l = path.getTotalLength();
            return function(d,i,a){
                return function(t){
                var p = path.getPointAtLength(t *l);
                    //console.log("----"+p.x+","+p.y+"---");
                    return "translate("+p.x +","+p.y+")";

                  };
            };
          }
              

            
           
              
 


          /*
          var l=t.getAttribute("Length");
          var speed=l/(ddd.road[i].UsedTime/3600.0);
          var color = color_choose(speed);
          
          
          show=t.getAttribute("show");
     //     console.log("display"+display);
          d3.select(t).style("stroke",color);
          d3.select(t).style("fill","white");

          var txt=t.getAttribute("data-content");
          var txtArr=txt.split(" ");//将名字，长度，速度分割，保留名字和长度，更新速度
          //console.log("txt"+txtArr.length);
          
          d3.select(t).attr("data-content",txtArr[0]+" "+txtArr[1]+" "+txtArr[2]+" 速度:"+speed+"km/h"+" ");
          */


          
      }
          }
          //console.log("--fin--"+i);

        }
      });




};
//道路选择按钮的触发函数
$(function() {
      var temp=$('#1');
    temp.change(function() {
          var c=this.checked;
          g.selectAll("path").each(function(){
           
            if(c&&this.getAttribute("Kind")=="2"){
                d3.select(this).attr("show","1");
                d3.select(this).style("display","");
              }
            else if(this.getAttribute("Kind")=="2"){
                d3.select(this).attr("show","0");
                d3.select(this).style("display","none");
          }
          });
        
    });
  });     
$(function() {
      var temp=$('#0');
    temp.change(function() {
          var c=this.checked;
          g.selectAll("path").each(function(){
           
            if(c&&this.getAttribute("Kind")=="1"){
                d3.select(this).attr("show","1");
              d3.select(this).style("display","");
              }
            else if(this.getAttribute("Kind")=="1"){
                d3.select(this).attr("show","0");
                d3.select(this).style("display","none");
          }
          });
        
    });
  });
$(function() {
      var temp=$('#2');
    temp.change(function() {
          var c=this.checked;
          g.selectAll("path").each(function(){
           
            if(c&&this.getAttribute("Kind")=="3"){
                d3.select(this).attr("show","1");
                d3.select(this).style("display","");
              }
            else if(this.getAttribute("Kind")=="3"){
                d3.select(this).attr("show","0");
                d3.select(this).style("display","none");
          }
          });
        
    });
  });
$(function() {
      var temp=$('#3');
    temp.change(function() {
          var c=this.checked;
          g.selectAll("path").each(function(){
           
            if(c&&this.getAttribute("Kind")=="4"){
                d3.select(this).attr("show","1");
                d3.select(this).style("display","");
              }
            else if(this.getAttribute("Kind")=="4"){
                d3.select(this).attr("show","0");
                d3.select(this).style("display","none");
          }
          });
        
    });
  });

$("input#road-search").keyup(function(){ //enter
    if(event.keyCode==13){
  var n=$("input#road-search").val();
  var t=document.getElementsByName(n);
  for(var i=0;i<t.length;i++)
  d3.select(t[i]).style("stroke-width","6.5px");
    }
  }
  
);

//$(function () {
//  $('[data-toggle="popover"]').popover()
//});

function searchRoad(){
  var n=$("input#road-search").val();
  var t=document.getElementsByName(n);//得到一个节点List
  if(t.length == 0)
  {
    console.log("未找到----->>>>>>>");
    alert("抱歉 所搜索路径未找到！")

  }
  console.log("路径已找到");
  for(var i=0;i<t.length;i++)
    d3.select(t[i]).style("stroke-width","10.5px");

};

    </script>
  </body>
</html>

