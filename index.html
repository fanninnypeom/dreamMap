<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>D3 World Map</title>
    <link href="http://libs.baidu.com/bootstrap/3.0.3/css/bootstrap.min.css" rel="stylesheet">
<link href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="http://developer.amap.com/Public/css/demo.Default.css" />   
    <style>
      path {
        stroke: black;
        stroke-width: 1.5px;
        fill: black;
      }
      .l{
        stroke: white;
        stroke-width:0.2px; 
      }
      .search-size{
        width:500px;
overflow-x:       }
#container {width:1300px; height: 1180px; }     
        stroke-width:1px; 
      }
    </style>
    <script src="http://d3js.org/d3.v3.min.js"></script>
  </head>

 

  <body>

<label class="checkbox-inline">
  <input id="0" type="checkbox" checked data-toggle="toggle"> 其他
</label>
<label class="checkbox-inline">
  <input id="1" type="checkbox" checked data-toggle="toggle"> 高速
</label>
<label class="checkbox-inline">
  <input id="2" type="checkbox" checked data-toggle="toggle"> 快速
</label>
<label class="checkbox-inline">
  <input id="3" type="checkbox" checked data-toggle="toggle"> 一般   
</label>


<div class="input-group search-size">
    <input id="road-search" type="text" class="form-control input-lg"><span class="input-group-addon btn btn-primary" onclick="searchRoad()">搜索</span>
</div>
<div id="container"></div> 


<script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
<script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>
<script type="text/javascript" src="http://webapi.amap.com/maps?v=1.3&key=abcf441d8ae25a58d7f6b0781bcb7347"></script>
<script src="http://libs.baidu.com/bootstrap/3.0.3/js/bootstrap.min.js"></script>
    <script charset="utf-8" type="text/javascript">

//------------以下为高德地图在线加载
//初始化地图对象，加载地图  

//------------------以上为高德地图在线加载
      var width = 1200;
      var height = 1000;

      var projection = d3.geo.mercator()
						.center([116, 40])
						.scale(62250)
    					.translate([width/4, height/4]);
      
      var svg = d3.select("body")
          .append("svg")
//          .attr("src","data/Beijing.svg")
          .attr("width", width)
          .attr("height", height);
      var ssvg=document.getElementById("ssvg");
      console.log("ssvg",ssvg);
      var path = d3.geo.path()
          .projection(projection);
      var g = svg.append("g");
      var color = d3.scale.category20();


      function color_choose(speed)
      {
          var color= "yellow";
                if(speed < 10)
                {
                    color= "#ff0000";
                }
                else if(speed < 20)
                {
                  color= "#ff3300";
                }
                else if(speed < 30)
                {
                  color= "#ff6600";
                }
                else if (speed <40)
                  color= "#ff9900";
                else if (speed <50)
                  color= "#ffcc00 ";
                else if (speed <60)
                  color= "#ffff00 ";
                else if (speed <70)
                  color= "#ccff00";
                else if (speed <80)
                  color= "#99ff00 ";
                else if (speed <90)
                  color= "#66ff00";
                else 
                  color= "#33ff00";
            return color;

      }

      var text_tile = svg.append("text")
                       .attr("x",15)
                       .attr("y",20)
                       .attr("dx","0.5em")
                       .attr("dy","1.5em")
                       .text(function(d){
                          return "Speed (km/h)"
                       });


      for(var i = 0;i<10;i++)
      {
        var colorect1 = svg.append("rect")
                           .attr("x",50)
                           .attr("y",70+i*20)
                           .attr("width",30)
                           .attr("height",20)
                           .style("fill",color_choose(5+i*10));

        var texts = svg.append("text")
                       .attr("x",15)
                       .attr("y",50+i*20)
                       .attr("dx","0.5em")
                       .attr("dy","1.5em")
                       .text(function(d){
                          return 10*i;
                       });

      }


        d3.text("data/RTICLINK_BeiJing.json","application/json;charset=utf-8",function(text){
          var topology=JSON.parse(text);
//      d3.json("data/RTICLINK_BeiJing.json", function(error, topology) {
          g.selectAll("path")
          .data(topology.features ) 
                    .enter()            
            .append("path")
          .attr("class", function(d,i){
               
                  return "l";  
            })
        .style("fill","white")

            .attr("d", path)
            .attr("id",function(d,i){
                return d.properties.MapID+String(parseInt(d.properties.Kind)-1)+d.properties.ID;
            })
            .attr("Kind",function(d,i){
              return d.properties.Kind;
            })
            .attr("Length",function(d,i){
                return d.properties.Length;
            }
            )
            .attr("name",function(d,i){
        return d.properties.Name;
            })
            .attr("show","1")
            .each(
              function(d,i){
                  var txt="Name: "+d.properties.Name+"  Length: "+d.properties.Length+"km";
  $(this).popover({
    trigger:"hover",
    content:txt,
    placement:"buttom",
    container: "body"
  })

              }
              );
//            .attr("data-toggle","popover")
 //           .attr("data-trigger","focus")
//            .attr("title","详细信息")
//            .attr("data-placement","top")
//            .attr("data-content",function(d,i){
//              return "名字: "+d.properties.Name+"长度: "+d.properties.Length;
//            })
//            .popover()
//            .on("mouseover",function(d,i){
                 //.popover('show');
                //document.getElementById
 //               $(d.properties.MapID+String(parseInt(d.properties.Kind)-1)+d.properties.ID).popover('show'); 
 //               console.log("名字"+d.properties.Name+"长度"+d.properties.Length);
 //           })
            ;
         });
 


      var a=d3.rgb(255,0,0);
      var b=d3.rgb(0,255,0);
      var compute=d3.interpolate(a,b);
      //new 
      var linear = d3.scale.linear()
                     .domain([0,50])
                     .range([0,1]);

      var ob=0;
        bigChange(ob);
      


function bigChange(o){

      file="data/"+o+"_extract.json";
      d3.json(file,function(err,ddd){
     
  var times=-1;

  var startTime=new Date().getTime();
  var timer=window.setInterval(function() 
{ 
  times=times+1;
  change(times); 
  }, 50); 

var a = 0,b =0,c = 0,d = 0,e= 0,f =0,g = 0,h=0,m=0,i=0;



function change(t){
      var t1=t;
        for(var i=t1*8227;i<(t1+1)*8227;i=i+1){
          
          if(i>ddd.road.length-1){
            clearInterval(timer); 
            console.log("time   "+ob);
            if(ob>22)
            return;
            else{
              ob=ob+1;
              bigChange(ob);
              var sum = a+b+c+d+e+f+g+h+m+i;
               a = 0,b =0,c = 0,d = 0,e= 0,f =0,g = 0,h=0,m=0,i=0;
            }
            return;
          }
          var id=ddd.road[i].ID;
          var t=document.getElementById(id);
          if(t!=null){
          var l=t.getAttribute("Length");
          var speed=l/(ddd.road[i].UsedTime/3600.0);
          var color = color_choose(speed);
          
          
          show=t.getAttribute("show");
     //     console.log("display"+display);
          d3.select(t).style("stroke",color);
          d3.select(t).style("fill","white");

//          if(show!="1")
//          d3.select(t).style("display","none");
//          t.style.cssText ="stroke: "+color+";stroke-width:0.5px;"+"fill:white";
          
//            t.style.cssText ="stroke: "+color+";stroke-width:0.5px;"+"fill:white"+
//          ";display:none";
}
          }
        }
      });

};
//道路选择按钮的触发函数
$(function() {
      var temp=$('#1');
    temp.change(function() {
          var c=this.checked;
          g.selectAll("path").each(function(){
           
            if(c&&this.getAttribute("Kind")=="2"){
                d3.select(this).attr("show","1");
                d3.select(this).style("display","");
              }
            else if(this.getAttribute("Kind")=="2"){
                d3.select(this).attr("show","0");
                d3.select(this).style("display","none");
          }
          });
        
    });
  });     
$(function() {
      var temp=$('#0');
    temp.change(function() {
          var c=this.checked;
          g.selectAll("path").each(function(){
           
            if(c&&this.getAttribute("Kind")=="1"){
                d3.select(this).attr("show","1");
              d3.select(this).style("display","");
              }
            else if(this.getAttribute("Kind")=="1"){
                d3.select(this).attr("show","0");
                d3.select(this).style("display","none");
          }
          });
        
    });
  });
$(function() {
      var temp=$('#2');
    temp.change(function() {
          var c=this.checked;
          g.selectAll("path").each(function(){
           
            if(c&&this.getAttribute("Kind")=="3"){
                d3.select(this).attr("show","1");
                d3.select(this).style("display","");
              }
            else if(this.getAttribute("Kind")=="3"){
                d3.select(this).attr("show","0");
                d3.select(this).style("display","none");
          }
          });
        
    });
  });
$(function() {
      var temp=$('#3');
    temp.change(function() {
          var c=this.checked;
          g.selectAll("path").each(function(){
           
            if(c&&this.getAttribute("Kind")=="4"){
                d3.select(this).attr("show","1");
                d3.select(this).style("display","");
              }
            else if(this.getAttribute("Kind")=="4"){
                d3.select(this).attr("show","0");
                d3.select(this).style("display","none");
          }
          });
        
    });
  });

$("input#road-search").keyup(function(){
    if(event.keyCode==13){
  var n=$("input#road-search").val();
  var t=document.getElementsByName(n);
  for(var i=0;i<t.length;i++)
  d3.select(t[i]).style("stroke-width","6.5px");
    }
  }
  
);

//$(function () {
//  $('[data-toggle="popover"]').popover()
//});

/*
$(".l").each(function(){
  var txt=$(this).html()
  $(this).popover({
    trigger:"click",
    content:txt,
    placement:"buttom",
  })
}).on("click",function(){
  $(".popover").hide();//隐藏popover
  $(this).popover("show");
});
*/
function searchRoad(){
  var n=$("input#road-search").val();
  var t=document.getElementsByName(n);//得到一个节点List
  for(var i=0;i<t.length;i++)
    d3.select(t[i]).style("stroke-width","6.5px");

};

    </script>
  </body>
</html>

